language: python

os:
  - linux

env:
  global:
    - HELM_VERSION=2.8.2
    - APPR_VERSION=0.7.4
    - APPR_URL=https://github.com/app-registry/appr/releases/download/v$APPR_VERSION/appr-linux-x64
    - secure: "DSeVGHpPrZamHMk/BMu7+roiPC3KA6umtlpOQv8a5+lJtc0QVj6Py3KkiM1CL5xZBuLOQrXPYc+Aopzq7o6L4mpmee8CGwxkQoAj0LsNR7QMI6QmjtTe7H23XXE64Z8v+TzYF34OtYC2hMg8gDQR9bhvF41RTPXBh26EntRT/xz8bJiIrAoHT3jvRQDw/OevZFnUw5uq0TyWadeLMUmqbaBZuQOqiv8SOcs6/QCjBpy/5v5gYVtbCrEVPoullX/Fngue1P6f36fAcJRrD5gwMIMdKTqSFF7XRxYFRKcjOdV+5enW8gw4IjzUxATm9AcoRv0mg1YqZ5jJ73rdHwW+Cm/v/cjyis0bDQfvb5bZpX+dm/VGd+Ror5LdtBKgBRvxxNxdYLy/j0aftoe7rsYQrhkrCDCLFIVbGmYTQia+NJp5n+2GDQxMuFlrUpzrkhI7OV5Cj8IW7na/fCPWFitc4dzF7q8DdGSqNyY1Ir1gKO/wXXNwgtj0+yFfFBja2M3aHFxdmWGZwlg16PR9cyLq/tzwTSo1eeHihODM4JL0959ZhtfqyexO6OFE2eMW1mD7/2lP/B9QdfyK/qi/2VnZNY4n1hu7KIOpQSp6biUiMAqHAIU36THtEpIwkx8fM9L+mHlwAWY2TquVBDHn2mSAD4s4BqEGMdgywqh5CumSk60="

install:
  - curl "https://kubernetes-helm.storage.googleapis.com/helm-v${HELM_VERSION}-linux-amd64.tar.gz" | tar zx
  - PATH=`pwd`/linux-amd64/:$PATH
  - mkdir -p ~/.helm/plugins
  - git clone https://github.com/app-registry/appr-helm-plugin.git ~/.helm/plugins/registry
  - curl -L "$APPR_URL" -o ~/.helm/plugins/registry/appr
  - chmod +x ~/.helm/plugins/registry/appr
  - helm version --client
  - helm init --client-only
  - helm registry version quay.io

script:
  - helm lint --set kube2iam.enable=true,prometheusOperator.enable=true kube-ingress-aws-controller/
  - helm registry login -u baez -p "$QUAY_IO_TOKEN" quay.io
  - cd kube-ingress-aws-controller/
  - helm registry push --namespace baez --channel alpha quay.io

deploy:
  provider: script
  script:
    - helm registry login -u baez+travis -p "$QUAY_IO_TOKEN" quay.io
    - cd kube-ingress-aws-controller/
    - helm registry push -v ${TRAVIS_TAG} --namespace baez quay.io
  on:
    tags: true
    all_branches: false